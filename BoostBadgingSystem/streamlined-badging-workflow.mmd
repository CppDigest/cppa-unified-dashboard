sequenceDiagram
    autonumber
    participant FE as Frontend
    participant IPFS as IPFS Service
    participant DB as Database
    participant Admin as Admin Wallet
    participant Sol as Token Contract<br/>(with vault functionality)
    participant Mail as Mailing Service
    participant Hook as Admin Webhook
    participant User as User (with email)
    participant Claim as Claim Service
    participant Wallet as User Wallet

    FE->>IPFS: Submit user + badge payload
    IPFS-->>FE: Return URI + CID metadata
    FE->>DB: Persist issuance record (user data, URI, flags)
    alt Blockchain-backed badge
        Admin->>FE: Initiate mint (via frontend with admin wallet)
        FE->>Admin: Request transaction signing (token IDs, URI, wallet)
        Admin->>FE: Sign mint or batch mint transaction
        FE->>Sol: Send mint transaction
        Sol-->>Wallet: Mint badge to user wallet (if provided)
        Sol-->>Sol: Store badge in contract (no wallet address)
        Sol-->>DB: Emit confirmation event (tx signatures)

        Sol-->>Mail: Trigger notification payload (wallet vs stored in contract)
        Mail-->>User: Send email (direct badge info or claim instructions)

        Note over Claim,DB: Claim service queries DB for contract-stored badges<br/>and associated recipient metadata

        User->>FE: Login & view claim notifications
        FE->>Claim: Request pending contract-stored badges
        Claim->>DB: Query pending badge notifications
        Claim-->>FE: Return selectable notifications
        User->>FE: Select badges
        FE->>Claim: Submit claim selection (URI, token ID, wallet) with newly registered wallet address
        Claim->>DB: Update claim intent, log timestamp
        Claim->>Hook: Send claim request payload (URI, token ID, wallet)
        Hook-->>Admin: Notify admin via webhook
        Admin->>FE: Initiate transfer (via frontend with admin wallet)
        FE->>Admin: Request transaction signing (from contract to wallet)
        Admin->>FE: Sign transfer transaction
        FE->>Sol: Send transfer transaction
        Sol-->>Wallet: Deliver claimed badge to user wallet
        Sol-->>DB: Record claim completion (tx signature, wallet)
        Mail-->>User: Send claim confirmation email
    else Database-only badge
        DB->>Mail: Generate database-only badge notification
        Mail-->>User: Send badge email (no wallet required)
        User->>FE: View badge notification history
        Note over DB: Database tracks issuance, views, and acknowledgements<br/>without blockchain transactions
    end

    Note over DB: Maintain full lifecycle history<br/>(metadata hash, issuance, claim selections, completion)

